<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport golden para iPhone 11 Pro Max -->
    <meta name="viewport" content="width=414px, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Tarjeta de Lealtad - Cafetería</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --cafe-oscuro: #4E342E;
            --cafe-medio: #795548;
            --cafe-claro: #D7CCC8;
            --dorado: #FFD700;
            --crema: #FFF9E6;
            --texto-oscuro: #3E2723;
            --verde: #2E7D32;
            --rojo: #C62828;
            --safe-area-inset: env(safe-area-inset-top, 0px);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html {
            width: 100vw;
            height: 100%;
            overflow-x: hidden;
            background: #f5f5f5;
            /* Ajuste exacto para 11 Pro Max */
            font-size: 16px;
        }
        
        body {
            width: 414px; /* Ancho lógico del dispositivo */
            height: 100%;
            margin: 0 auto;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            color: var(--texto-oscuro);
            padding: 15px;
            background-color: #f5f5f5;
        }
        
        .container {
            width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, var(--cafe-oscuro) 0%, var(--cafe-medio) 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        
        .header h1 {
            margin-bottom: 8px;
            font-size: 1.8rem;
        }
        
        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .badge {
            display: inline-block;
            background: var(--dorado);
            color: var(--cafe-oscuro);
            padding: 6px 15px;
            border-radius: 18px;
            font-weight: bold;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .tab.active {
            background: var(--cafe-medio);
            color: white;
        }
        
        .tab:not(.active):hover {
            background: var(--cafe-claro);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
        }
        
        .card.active {
            display: block;
        }
        
        .card h2 {
            color: var(--cafe-oscuro);
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--cafe-claro);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--cafe-oscuro);
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--cafe-claro);
            border-radius: 6px;
            font-size: 16px; /* Tamaño mínimo para iOS */
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            border-color: var(--cafe-medio);
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--cafe-oscuro) 0%, var(--cafe-medio) 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 6px;
            font-size: 16px; /* Tamaño mínimo para iOS */
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .alert-success {
            background-color: #E8F5E9;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }
        
        .alert-error {
            background-color: #FFEBEE;
            color: #C62828;
            border-left: 4px solid #F44336;
        }
        
        .alert-info {
            background-color: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }
        
        .alert i {
            font-size: 1.1rem;
        }
        
        .hidden {
            display: none;
        }
        
        .customer-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .customer-detail {
            flex: 1;
        }
        
        .customer-name {
            font-weight: 600;
            color: var(--cafe-oscuro);
            font-size: 1.3rem;
        }
        
        .customer-phone {
            font-size: 0.95rem;
            color: var(--cafe-medio);
        }
        
        .customer-visits {
            text-align: center;
        }
        
        .visits-count {
            font-size: 2rem;
            font-weight: bold;
            color: var(--cafe-oscuro);
        }
        
        .visits-label {
            font-size: 0.9rem;
            color: var(--cafe-medio);
        }
        
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .stamp-slot {
            width: 50px;
            height: 50px;
            border: 2px dashed var(--cafe-medio);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.7);
            font-weight: bold;
            font-size: 1rem;
        }
        
        .stamped {
            background-color: var(--dorado);
            border: 2px solid var(--cafe-oscuro);
        }
        
        .gold-star {
            color: var(--cafe-oscuro);
            font-size: 22px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--crema);
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--cafe-oscuro);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--cafe-medio);
        }
        
        .rewards-section {
            margin-top: 20px;
        }
        
        .reward-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--cafe-claro);
            border-radius: 8px;
            margin-bottom: 12px;
            background: white;
        }
        
        .reward-icon {
            width: 40px;
            height: 40px;
            background: var(--dorado);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2rem;
            color: var(--cafe-oscuro);
        }
        
        .reward-info {
            flex: 1;
        }
        
        .reward-title {
            font-weight: 600;
            color: var(--cafe-oscuro);
            font-size: 0.95rem;
        }
        
        .reward-desc {
            font-size: 0.85rem;
            color: var(--cafe-medio);
        }
        
        .reward-status {
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-available {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-pending {
            background: #FFF8E1;
            color: #FF8F00;
        }
        
        .status-claimed {
            background: #E3F2FD;
            color: #1565C0;
        }
        
        .qr-section {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--crema);
            border-radius: 8px;
        }
        
        .qr-code {
            width: 120px;
            height: 120px;
            margin: 0 auto 12px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: var(--cafe-oscuro);
        }
        
        .qr-desc {
            font-size: 0.85rem;
            color: var(--cafe-medio);
            margin-top: 8px;
        }
        
        /* Ajuste notch */
        @supports(padding: max(0px)) {
            body {
                padding-left: max(env(safe-area-inset-left), 0px);
                padding-right: max(env(safe-area-inset-right), 0px);
            }
        }
        
        /* Ajustes específicos para dispositivos móviles */
        @media (max-width: 414px) {
            body {
                width: 100%;
                padding: 12px;
            }
            
            .container {
                width: 100%;
            }
            
            .stamp-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .stamp-slot {
                width: 45px;
                height: 45px;
                font-size: 0.9rem;
            }
            
            .gold-star {
                font-size: 20px;
            }
            
            .customer-info {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-star"></i> Tarjeta de Lealtad</h1>
            <p>Sistema de fidelidad de nuestra cafetería</p>
            <div class="badge">Programa de Lealtad</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="register">Registrarse</div>
            <div class="tab" data-tab="consult">Consultar Tarjeta</div>
        </div>
        
        <!-- Pestaña de Registro -->
        <div class="card active" id="registerCard">
            <h2><i class="fas fa-user-plus"></i> Registro de Cliente</h2>
            
            <div class="form-group">
                <label for="registerName"><i class="fas fa-user"></i> Nombre Completo</label>
                <input type="text" id="registerName" placeholder="Ingresa tu nombre completo">
            </div>
            
            <div class="form-group">
                <label for="registerPhone"><i class="fas fa-phone"></i> Número de Teléfono</label>
                <input type="tel" id="registerPhone" placeholder="Ingresa tu número de teléfono">
            </div>
            
            <div class="form-group">
                <label for="registerEmail"><i class="fas fa-envelope"></i> Correo Electrónico (Opcional)</label>
                <input type="email" id="registerEmail" placeholder="Ingresa tu correo electrónico">
            </div>
            
            <button class="btn" id="registerBtn">
                <i class="fas fa-check-circle"></i> Registrar
            </button>
            
            <div id="registerAlert" class="alert hidden">
                <i class="fas fa-info-circle"></i>
                <span id="registerAlertMessage"></span>
            </div>
        </div>
        
        <!-- Pestaña de Consulta -->
        <div class="card" id="consultCard">
            <h2><i class="fas fa-search"></i> Consultar Tarjeta</h2>
            
            <div class="form-group">
                <label for="consultPhone"><i class="fas fa-phone"></i> Número de Teléfono</label>
                <input type="tel" id="consultPhone" placeholder="Ingresa tu número de teléfono registrado">
            </div>
            
            <button class="btn" id="consultBtn">
                <i class="fas fa-search"></i> Ver mi Tarjeta
            </button>
            
            <div id="consultAlert" class="alert hidden">
                <i class="fas fa-info-circle"></i>
                <span id="consultAlertMessage"></span>
            </div>
        </div>
        
        <!-- Tarjeta de Lealtad (se muestra después del registro/consulta) -->
        <div class="card" id="loyaltyCard">
            <h2><i class="fas fa-user"></i> Mi Información</h2>
            
            <div class="customer-info">
                <div class="customer-detail">
                    <div class="customer-name" id="customerName">Carlos Mendoza</div>
                    <div class="customer-phone" id="customerPhoneText">555-123-4567</div>
                </div>
                <div class="customer-visits">
                    <div class="visits-count" id="visitsCount">0</div>
                    <div class="visits-label">visitas acumuladas</div>
                </div>
            </div>
            
            <h3 style="margin: 20px 0 12px; text-align: center; color: var(--cafe-oscuro);">
                <i class="fas fa-star"></i> Mis Estrellas <i class="fas fa-star"></i>
            </h3>
            
            <div class="stamp-grid" id="stampGrid">
                <!-- Las estrellas se generarán dinámicamente con JavaScript -->
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalVisits">0</div>
                    <div class="stat-label">Visitas totales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="remainingVisits">5</div>
                    <div class="stat-label">Para próxima recompensa</div>
                </div>
            </div>
            
            <div class="qr-section">
                <div class="qr-code" id="customerQr">
                    <i class="fas fa-coffee"></i>
                </div>
                <p class="qr-desc">Muestra este código al realizar tu pedido para acumular visitas</p>
            </div>
            
            <button class="btn" id="backBtn" style="margin-top: 15px;">
                <i class="fas fa-arrow-left"></i> Volver
            </button>
        </div>
        
        <!-- Sección de Recompensas -->
        <div class="card" id="rewardsCard">
            <h2><i class="fas fa-gift"></i> Mis Recompensas</h2>
            
            <div class="rewards-section" id="rewardsList">
                <!-- Las recompensas se generarán dinámicamente con JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE JSONBIN (TUS DATOS)
        const BIN_ID = '68b8a06b43b1c97be935dc93';
        const API_KEY = '$2a$10$CVg51pmEVPT3AsAUJqlyvubFoEM3Za/uRhQzUmO7Ch2dVbgkm2HLW';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        
        // Elementos DOM
        const tabs = document.querySelectorAll('.tab');
        const cards = document.querySelectorAll('.card');
        const registerCard = document.getElementById('registerCard');
        const consultCard = document.getElementById('consultCard');
        const loyaltyCard = document.getElementById('loyaltyCard');
        const rewardsCard = document.getElementById('rewardsCard');
        
        const registerName = document.getElementById('registerName');
        const registerPhone = document.getElementById('registerPhone');
        const registerEmail = document.getElementById('registerEmail');
        const registerBtn = document.getElementById('registerBtn');
        const registerAlert = document.getElementById('registerAlert');
        const registerAlertMessage = document.getElementById('registerAlertMessage');
        
        const consultPhone = document.getElementById('consultPhone');
        const consultBtn = document.getElementById('consultBtn');
        const consultAlert = document.getElementById('consultAlert');
        const consultAlertMessage = document.getElementById('consultAlertMessage');
        
        const customerName = document.getElementById('customerName');
        const customerPhoneText = document.getElementById('customerPhoneText');
        const visitsCount = document.getElementById('visitsCount');
        const totalVisits = document.getElementById('totalVisits');
        const remainingVisits = document.getElementById('remainingVisits');
        const stampGrid = document.getElementById('stampGrid');
        const rewardsList = document.getElementById('rewardsList');
        const backBtn = document.getElementById('backBtn');
        
        let currentClient = null;
        
        // Cambiar entre pestañas
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Actualizar pestañas activas
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Mostrar la tarjeta correspondiente
                cards.forEach(card => card.classList.remove('active'));
                if (tabId === 'register') {
                    registerCard.classList.add('active');
                } else {
                    consultCard.classList.add('active');
                }
            });
        });
        
        // Mostrar alerta
        function showAlert(alertElement, messageElement, message, type) {
            messageElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.classList.remove('hidden');
            
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }
        
        // Obtener clientes
        async function getClients() {
            try {
                const response = await fetch(API_URL, {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener datos');
                }
                
                const data = await response.json();
                return data.record.clients || [];
            } catch (error) {
                console.error('Error:', error);
                showAlert(registerAlert, registerAlertMessage, 'Error al conectar con la base de datos', 'error');
                return [];
            }
        }
        
        // Guardar clientes
        async function saveClients(clients) {
            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify({ clients })
                });
                
                if (!response.ok) {
                    throw new Error('Error al guardar datos');
                }
                
                return true;
            } catch (error) {
                console.error('Error:', error);
                showAlert(registerAlert, registerAlertMessage, 'Error al guardar en la base de datos', 'error');
                return false;
            }
        }
        
        // Registrar nuevo cliente
        async function registerClient() {
            const name = registerName.value.trim();
            const phone = registerPhone.value.trim();
            const email = registerEmail.value.trim();
            
            if (!name || !phone) {
                showAlert(registerAlert, registerAlertMessage, 'Por favor, completa todos los campos obligatorios', 'error');
                return;
            }
            
            // Obtener clientes existentes
            const clients = await getClients();
            
            // Verificar si el cliente ya existe
            const clientExists = clients.some(client => client.phone === phone);
            if (clientExists) {
                showAlert(registerAlert, registerAlertMessage, 'Este número de teléfono ya está registrado', 'error');
                // Cambiar a la pestaña de consulta
                tabs[1].click();
                consultPhone.value = phone;
                return;
            }
            
            // Agregar nuevo cliente
            const newClient = {
                id: Date.now().toString(),
                name,
                phone,
                email,
                visits: 0,
                stars: 0,
                registrationDate: new Date().toISOString(),
                lastVisit: null
            };
            
            clients.push(newClient);
            
            // Guardar en la base de datos
            const success = await saveClients(clients);
            
            if (success) {
                showAlert(registerAlert, registerAlertMessage, `¡Registro exitoso, ${name}!`, 'success');
                
                // Mostrar la tarjeta del cliente
                loadClientData(newClient);
                
                // Ocultar formularios y mostrar tarjeta
                registerCard.classList.remove('active');
                consultCard.classList.remove('active');
                loyaltyCard.classList.add('active');
                rewardsCard.classList.add('active');
            }
        }
        
        // Consultar cliente existente
        async function consultClient() {
            const phone = consultPhone.value.trim();
            
            if (!phone) {
                showAlert(consultAlert, consultAlertMessage, 'Por favor, ingresa tu número de teléfono', 'error');
                return;
            }
            
            const clients = await getClients();
            const client = clients.find(c => c.phone === phone);
            
            if (!client) {
                showAlert(consultAlert, consultAlertMessage, 'No se encontró ningún cliente con este número', 'error');
                return;
            }
            
            // Mostrar la tarjeta del cliente
            loadClientData(client);
            
            // Ocultar formularios y mostrar tarjeta
            consultCard.classList.remove('active');
            loyaltyCard.classList.add('active');
            rewardsCard.classList.add('active');
            
            showAlert(consultAlert, consultAlertMessage, `¡Bienvenido ${client.name}!`, 'success');
        }
        
        // Cargar datos del cliente en la tarjeta
        function loadClientData(client) {
            currentClient = client;
            
            // Mostrar información del cliente
            customerName.textContent = client.name;
            customerPhoneText.textContent = client.phone;
            visitsCount.textContent = client.visits;
            totalVisits.textContent = client.visits;
            remainingVisits.textContent = Math.max(0, 5 - (client.visits % 5));
            
            // Actualizar estampas
            updateStampGrid(client.visits);
            
            // Actualizar recompensas
            updateRewards(client.visits);
        }
        
        // Volver atrás
        function goBack() {
            loyaltyCard.classList.remove('active');
            rewardsCard.classList.remove('active');
            consultCard.classList.add('active');
            consultPhone.value = '';
        }
        
        // Actualizar cuadrícula de estampas
        function updateStampGrid(visits) {
            stampGrid.innerHTML = '';
            
            // Calcular el número de estrellas completas (cada 5 visitas = 1 estrella)
            const completedStars = Math.floor(visits / 5);
            const currentProgress = visits % 5;
            
            for (let i = 1; i <= 5; i++) {
                const stampSlot = document.createElement('div');
                stampSlot.className = 'stamp-slot';
                
                if (i <= currentProgress) {
                    stampSlot.classList.add('stamped');
                    const starIcon = document.createElement('i');
                    starIcon.className = 'fas fa-star gold-star';
                    stampSlot.appendChild(starIcon);
                } else {
                    stampSlot.textContent = i;
                }
                
                stampGrid.appendChild(stampSlot);
            }
            
            // Mostrar contador de recompensas ganadas
            const rewardCounter = document.createElement('div');
            rewardCounter.style.gridColumn = '1 / -1';
            rewardCounter.style.textAlign = 'center';
            rewardCounter.style.marginTop = '8px';
            rewardCounter.style.color = 'var(--cafe-medio)';
            rewardCounter.innerHTML = `<i class="fas fa-trophy"></i> Has ganado ${completedStars} recompensa(s) completa(s)`;
            stampGrid.appendChild(rewardCounter);
        }
        
        // Actualizar recompensas disponibles
        function updateRewards(visits) {
            rewardsList.innerHTML = '';
            
            const rewards = [
                { visits: 5, title: 'Café Gratis', desc: 'Canjea después de 5 visitas', icon: 'coffee' },
                { visits: 10, title: 'Postre Gratis', desc: 'Canjea después de 10 visitas', icon: 'cookie' },
                { visits: 15, title: 'Desayuno Completo', desc: 'Canjea después de 15 visitas', icon: 'bacon' },
                { visits: 20, title: 'Combo Especial', desc: 'Canjea después de 20 visitas', icon: 'gift' }
            ];
            
            rewards.forEach(reward => {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'reward-item';
                
                let statusClass = '';
                let statusText = '';
                
                if (visits >= reward.visits) {
                    statusClass = 'status-available';
                    statusText = 'Disponible';
                } else {
                    statusClass = 'status-pending';
                    statusText = `Faltan ${reward.visits - visits} visitas`;
                }
                
                rewardItem.innerHTML = `
                    <div class="reward-icon">
                        <i class="fas fa-${reward.icon}"></i>
                    </div>
                    <div class="reward-info">
                        <div class="reward-title">${reward.title}</div>
                        <div class="reward-desc">${reward.desc}</div>
                    </div>
                    <div class="reward-status ${statusClass}">${statusText}</div>
                `;
                
                rewardsList.appendChild(rewardItem);
            });
        }
        
        // Event Listeners
        registerBtn.addEventListener('click', registerClient);
        consultBtn.addEventListener('click', consultClient);
        backBtn.addEventListener('click', goBack);
        
        registerPhone.addEventListener('keypress', e => { if (e.key === 'Enter') registerClient(); });
        consultPhone.addEventListener('keypress', e => { if (e.key === 'Enter') consultClient(); });
    </script>
</body>
</html>