<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=414px, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Tarjeta de Lealtad Maestra María</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --safe-area-inset: env(safe-area-inset-top, 0px);
            --gold-color: #ffd700;
            --dark-gold: #d4af37;
            --light-bg: #fffae6;
            --maroon: #800020;
            --cream: #fffdd0;
        }
        * {
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }
        html {
            width: 100vw;
            height: 100%;
            overflow-x: hidden;
            background: #000;
            font-size: 16px;
        }
        body {
            width: 414px;
            height: 100%;
            margin: 0 auto;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--cream);
            font-family: 'Georgia', serif;
            color: #333;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23fffdd0"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23ffd700" stroke-width="1" stroke-opacity="0.1"/></svg>');
        }
        .container {
            padding: 20px;
            padding-top: max(env(safe-area-inset-top), 20px);
            padding-bottom: max(env(safe-area-inset-bottom), 20px);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px 0;
            background: linear-gradient(135deg, var(--maroon) 0%, #a00030 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--dark-gold);
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .card-loyalty {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 3px solid var(--dark-gold);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><path d="M0,0 L60,60 M60,0 L0,60" stroke="%23ffd700" stroke-width="0.5" stroke-opacity="0.1"/></svg>');
        }
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin: 25px 0;
        }
        .stamp-slot {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--dark-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            background-color: var(--light-bg);
            position: relative;
        }
        .stamped {
            background-color: var(--gold-color);
            border: 2px solid var(--dark-gold);
        }
        .gold-star {
            width: 50px;
            height: 50px;
            margin: 5px;
            filter: drop-shadow(0px 3px 2px rgba(0, 0, 0, 0.3));
        }
        .form-group {
            margin-bottom: 15px;
        }
        input[type="tel"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            -webkit-appearance: none;
            background-color: #fff;
            font-family: 'Georgia', serif;
        }
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--maroon) 0%, #a00030 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Georgia', serif;
            border: 1px solid var(--dark-gold);
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .admin-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 2px solid var(--dark-gold);
        }
        .admin-section h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--maroon);
            font-weight: bold;
        }
        .request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .request-actions {
            display: flex;
            gap: 10px;
        }
        .btn-approve {
            background: #28a745;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #1e7e34;
        }
        .btn-deny {
            background: #dc3545;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #c82333;
        }
        .alert {
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--dark-gold);
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e9ecef;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }
        .tab.active {
            background: linear-gradient(135deg, var(--maroon) 0%, #a00030 100%);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .history-date {
            color: #6c757d;
            font-size: 12px;
        }
        .brand-logo {
            font-size: 18px;
            font-weight: bold;
            color: var(--maroon);
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.2);
        }
        .reward-text {
            font-style: italic;
            color: var(--maroon);
            margin-top: 15px;
            font-weight: bold;
        }
        .gold-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold-color), transparent);
            margin: 15px 0;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #6c757d;
            font-size: 12px;
        }
        .premium-border {
            border: 2px solid var(--dark-gold);
            border-radius: 20px;
            padding: 3px;
            background: linear-gradient(45deg, var(--light-bg), #ffffff, var(--light-bg));
        }
        .vip-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--maroon);
            color: gold;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid gold;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tarjeta de Lealtad Maestra María</h1>
            <p>Gana estrellas con cada visita</p>
        </div>
        
        <div class="brand-logo">MAESTRA MARÍA • ARTESANÍAS FINAS</div>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('customer')">Cliente</div>
            <div class="tab" onclick="switchTab('admin')">Gerente</div>
        </div>
        
        <!-- Área de Clientes -->
        <div id="customerTab" class="tab-content active">
            <div class="premium-border">
                <div class="card-loyalty">
                    <h3>Mi Tarjeta de Lealtad</h3>
                    <div class="gold-divider"></div>
                    <p>¡Acumula 10 visitas y obtén una recompensa especial!</p>
                    
                    <div class="stamp-grid" id="stampGrid">
                        <!-- Los espacios para estrellas se generarán con JavaScript -->
                    </div>
                    
                    <div class="reward-text">¡Después de 10 visitas, tu próxima compra tiene 20% de descuento!</div>
                    
                    <div class="form-group">
                        <input type="tel" id="phoneInput" placeholder="Ingresa tu número de teléfono" inputmode="numeric">
                    </div>
                    <button onclick="requestVisit()">Solicitar Registro de Visita</button>
                    
                    <div id="customerMessage" class="alert"></div>
                </div>
            </div>
            
            <div class="premium-border">
                <div class="card-loyalty">
                    <h3>Mi Historial de Visitas</h3>
                    <button onclick="viewHistory()">Ver mi Historial</button>
                    <div id="customerHistory"></div>
                </div>
            </div>
        </div>
        
        <!-- Área de Gerente -->
        <div id="adminTab" class="tab-content">
            <div class="premium-border">
                <div class="admin-section">
                    <h3>Panel de Control - Gerente</h3>
                    <div id="pendingRequests">
                        <p class="text-center">Cargando solicitudes...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Sistema de Lealtad Maestra María • 2023
        </div>
    </div>

    <script>
        // Configuración de Firebase (debes reemplazar con tus propios valores)
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Referencias a colecciones
        const customersRef = db.collection("customers");
        const visitsRef = db.collection("visits");
        const pendingRef = db.collection("pendingVisits");
        
        // Estado de la aplicación
        let currentCustomer = null;
        
        // Función para cambiar entre pestañas
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'customer') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('customerTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                loadPendingRequests();
            }
        }
        
        // Función para solicitar una visita
        function requestVisit() {
            const phone = document.getElementById('phoneInput').value.trim();
            const messageEl = document.getElementById('customerMessage');
            
            if (!phone) {
                showMessage('Por favor ingresa tu número de teléfono', 'error');
                return;
            }
            
            // Validar formato de teléfono (simple)
            if (!/^[0-9+]{10,15}$/.test(phone)) {
                showMessage('Por favor ingresa un número de teléfono válido', 'error');
                return;
            }
            
            showMessage('Solicitando registro de visita...', 'info');
            
            // Guardar la solicitud en pendientes
            pendingRef.add({
                phone: phone,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            })
            .then(() => {
                showMessage('Solicitud enviada. Espera la autorización del gerente.', 'success');
                document.getElementById('phoneInput').value = '';
            })
            .catch(error => {
                console.error('Error al solicitar visita:', error);
                showMessage('Error al enviar la solicitud. Intenta nuevamente.', 'error');
            });
        }
        
        // Función para mostrar mensajes al cliente
        function showMessage(message, type) {
            const messageEl = document.getElementById('customerMessage');
            messageEl.textContent = message;
            messageEl.className = 'alert';
            messageEl.classList.add(`alert-${type}`);
            messageEl.style.display = 'block';
            
            // Ocultar el mensaje después de 5 segundos
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        // Función para cargar solicitudes pendientes (área de gerente)
        function loadPendingRequests() {
            const pendingEl = document.getElementById('pendingRequests');
            pendingEl.innerHTML = '<p class="text-center">Cargando solicitudes...</p>';
            
            pendingRef.where('status', '==', 'pending').orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        pendingEl.innerHTML = '<p class="text-center">No hay solicitudes pendientes</p>';
                        return;
                    }
                    
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="request-item">
                                <div>
                                    <strong>${data.phone}</strong>
                                    <div class="history-date">${formatDate(data.timestamp?.toDate())}</div>
                                </div>
                                <div class="request-actions">
                                    <button class="btn-approve" onclick="approveVisit('${doc.id}', '${data.phone}')">Aprobar</button>
                                    <button class="btn-deny" onclick="denyVisit('${doc.id}')">Rechazar</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    pendingEl.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error al cargar solicitudes:', error);
                    pendingEl.innerHTML = '<p class="text-center">Error al cargar solicitudes</p>';
                });
        }
        
        // Función para aprobar una visita
        function approveVisit(requestId, phone) {
            // Primero, obtener o crear el cliente
            customersRef.where('phone', '==', phone).get()
                .then(snapshot => {
                    let customerId;
                    
                    if (snapshot.empty) {
                        // Crear nuevo cliente
                        return customersRef.add({
                            phone: phone,
                            visits: 1,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastVisit: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(docRef => {
                            customerId = docRef.id;
                            // Registrar la visita
                            return visitsRef.add({
                                customerId: customerId,
                                phone: phone,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                approvedBy: 'manager'
                            });
                        });
                    } else {
                        // Cliente existente
                        const customerDoc = snapshot.docs[0];
                        customerId = customerDoc.id;
                        const currentVisits = customerDoc.data().visits || 0;
                        
                        // Actualizar el contador de visitas
                        return customersRef.doc(customerId).update({
                            visits: currentVisits + 1,
                            lastVisit: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            // Registrar la visita
                            return visitsRef.add({
                                customerId: customerId,
                                phone: phone,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                approvedBy: 'manager'
                            });
                        });
                    }
                })
                .then(() => {
                    // Marcar la solicitud como aprobada
                    return pendingRef.doc(requestId).update({
                        status: 'approved',
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // Recargar las solicitudes pendientes
                    loadPendingRequests();
                    showManagerMessage('Visita aprobada correctamente');
                })
                .catch(error => {
                    console.error('Error al aprobar visita:', error);
                    showManagerMessage('Error al aprobar la visita');
                });
        }
        
        // Función para rechazar una visita
        function denyVisit(requestId) {
            pendingRef.doc(requestId).update({
                status: 'denied',
                processedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadPendingRequests();
                showManagerMessage('Solicitud rechazada');
            })
            .catch(error => {
                console.error('Error al rechazar visita:', error);
                showManagerMessage('Error al rechazar la solicitud');
            });
        }
        
        // Función para mostrar mensaje al gerente
        function showManagerMessage(message) {
            // Podrías implementar un sistema de notificación para el gerente
            console.log("Mensaje para el gerente:", message);
            alert(message);
        }
        
        // Función para ver el historial del cliente
        function viewHistory() {
            const phone = document.getElementById('phoneInput').value.trim();
            const historyEl = document.getElementById('customerHistory');
            
            if (!phone) {
                showMessage('Por favor ingresa tu número de teléfono primero', 'error');
                return;
            }
            
            historyEl.innerHTML = '<p class="text-center">Cargando historial...</p>';
            
            // Buscar el cliente
            customersRef.where('phone', '==', phone).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        historyEl.innerHTML = '<p class="text-center">No se encontró historial para este número</p>';
                        return;
                    }
                    
                    const customerDoc = snapshot.docs[0];
                    const customerData = customerDoc.data();
                    
                    // Obtener todas las visitas del cliente
                    return visitsRef.where('customerId', '==', customerDoc.id)
                        .orderBy('timestamp', 'desc')
                        .get()
                        .then(visitSnapshot => {
                            let html = `<p>Total de visitas: <strong>${customerData.visits || 0}</strong></p>`;
                            
                            if (visitSnapshot.empty) {
                                html += '<p>No hay visitas registradas</p>';
                            } else {
                                html += '<div style="max-height: 300px; overflow-y: auto;">';
                                visitSnapshot.forEach(visitDoc => {
                                    const visitData = visitDoc.data();
                                    html += `
                                        <div class="history-item">
                                            <div>Visita registrada</div>
                                            <div class="history-date">${formatDate(visitData.timestamp?.toDate())}</div>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                            }
                            
                            historyEl.innerHTML = html;
                            
                            // Actualizar la visualización de estrellas
                            updateStampGrid(customerData.visits || 0);
                        });
                })
                .catch(error => {
                    console.error('Error al cargar historial:', error);
                    historyEl.innerHTML = '<p class="text-center">Error al cargar el historial</p>';
                });
        }
        
        // Función para actualizar la cuadrícula de estrellas
        function updateStampGrid(visits) {
            const gridEl = document.getElementById('stampGrid');
            gridEl.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const stampSlot = document.createElement('div');
                stampSlot.className = 'stamp-slot';
                
                if (i <= visits) {
                    stampSlot.classList.add('stamped');
                    const starImg = document.createElement('img');
                    // En un caso real, aquí usarías tu imagen de Canva
                    starImg.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23FFD700" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
                    starImg.alt = 'Estrella dorada';
                    starImg.className = 'gold-star';
                    stampSlot.appendChild(starImg);
                    
                    // Añadir insignia VIP después de 5 visitas
                    if (i === 5) {
                        const vipBadge = document.createElement('div');
                        vipBadge.className = 'vip-badge';
                        vipBadge.innerHTML = '5';
                        stampSlot.appendChild(vipBadge);
                    }
                } else {
                    stampSlot.textContent = i;
                }
                
                gridEl.appendChild(stampSlot);
            }
        }
        
        // Función auxiliar para formatear fechas
        function formatDate(date) {
            if (!date) return 'Fecha no disponible';
            
            return new Intl.DateTimeFormat('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
        
        // Inicializar la cuadrícula de estrellas
        updateStampGrid(0);
    </script>
</body>
</html>